{"version":3,"file":"bundle.js","sources":["../node_modules/browserify/node_modules/browser-pack/_prelude.js","../lib/index.js","../lib/KwsContentPlayer.js","../lib/KwsContentUploader.js","../lib/KwsWebRtcContent.js","../lib/Content.js","../node_modules/browserify/node_modules/events/events.js","../node_modules/inherits/inherits_browser.js","../node_modules/xmlhttprequest/lib/browser.js","../node_modules/kws-rpc-builder/lib/index.js","../node_modules/kws-rpc-builder/lib/Mapper.js","../node_modules/kws-rpc-builder/lib/packers/index.js","../node_modules/kws-rpc-builder/lib/packers/JsonRPC.js","../node_modules/kws-rpc-builder/lib/packers/XmlRPC.js"],"names":["KwsContentPlayer","require","KwsContentUploader","KwsWebRtcContent","exports","url","options","success","result","self","_video","remote","remoteVideoTag","remoteVideo","_setRemoteVideoTag","addEventListener","terminate","console","warn","emit","close","reason","Content","REASON_SERVER_ENDED_SESSION","document","getElementById","src","removeAttribute","undefined","autostart","call","this","Content_start","start","params","constraints","audio","video","on","inherits","module","drop","event","stopPropagation","preventDefault","_filesContainer","dataTransfer","dragover","dropEffect","sendFiles","container","files","send","doSend","file","xhr","XMLHttpRequest","upload","error","log","open","inputTag","input","SyntaxError","dragdropTag","div","filesContainer","sessionId","FileList","lenght","f","formData","FormData","i","append","useFormData","initDragDrop","id","onerror","initRtc","localStream","iceServers","pc","RTCPeerConnection","optional","DtlsSrtpKeyAgreement","addStream","mediaConstraints","mandatory","OfferToReceiveAudio","_audio","OfferToReceiveVideo","createOffer","offer","setLocalDescription","info","onicecandidate","candidate","sdp","localDescription","debug","onsignalingstatechange","signalingState","setRemoteDescription","RTCSessionDescription","type","success2","local","stream","getLocalStreams","Error","URL","createObjectURL","localVideoTag","localVideo","msg","muted","getRemoteStreams","getUserMedia","decodeMode","RangeError","setSessionId","TypeError","_sessionId","doRPC","method","callback","rpc","encode","decode","responseText","pollMediaEvents","error_tries","contentEvents","data","controlEvents","terminatedByServer","pollingTimeout","clearTimeout","setTimeout","failure","code","MAX_ALLOWED_ERROR_TRIES","Math","pow","terminateConnection","polling","startPolling","action","EventEmitter","ERROR_NO_REMOTE_VIDEO_TAG","maxFrameRate","MAX_FRAMERATE","__defineGetter__","RpcBuilder","JsonRPC","request_timeout","rejected","execute","command","commandResult","REASON_USER_ENDED_SESSION","packers","message","_events","_maxListeners","isFunction","arg","isNumber","isObject","isUndefined","prototype","defaultMaxListeners","setMaxListeners","n","isNaN","er","handler","len","args","listeners","length","arguments","Array","apply","slice","addListener","listener","m","newListener","push","warned","trace","once","g","removeListener","fired","list","position","splice","removeAllListeners","key","ret","listenerCount","emitter","Object","create","ctor","superCtor","super_","constructor","value","enumerable","writable","configurable","TempCtor","unifyResponseMethods","responseMethods","response","unifyTransport","transport","Function","bind","postMessage","onmessage","RpcNotification","defineProperty","packer","onRequest","transportMessage","storeResponse","dest","timeout","responses","remove","response_timeout","set","storeProcessedResponse","ack","from","processedResponses","duplicates_timeout","RpcRequest","get","Boolean","responseMethod","pack","reply","peerID","cancel","message2Key","request","requests","pop","unpack","max_retries","removeEventListener","BASE_TIMEOUT","requestID","Mapper","forEach","dispatchCallback","sendRequest","retried","encode_transport","retry","processRequest","idAck","processResponse","duplicatedResponse","e","processed","sessionID","sources","source","key2","ids","keys","XmlRPC","jsonrpc","JSON","stringify","String","parse","version","result_defined","error_defined"],"mappings":"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","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error(\"Cannot find module '\"+o+\"'\")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","/*\n * (C) Copyright 2013 Kurento (http://kurento.org/)\n *\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the GNU Lesser General Public License\n * (LGPL) version 2.1 which accompanies this distribution, and is available at\n * http://www.gnu.org/licenses/lgpl-2.1.html\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n */\n\n/**\n * @module kwsContentApi\n *\n * @copyright 2013 Kurento (http://kurento.org/)\n * @license LGPL\n */\n\nvar KwsContentPlayer   = require('./KwsContentPlayer');\nvar KwsContentUploader = require('./KwsContentUploader');\nvar KwsWebRtcContent   = require('./KwsWebRtcContent');\n\n\nexports.KwsContentPlayer   = KwsContentPlayer;\nexports.KwsContentUploader = KwsContentUploader;\nexports.KwsWebRtcContent   = KwsWebRtcContent;","/*\n * (C) Copyright 2013 Kurento (http://kurento.org/)\n *\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the GNU Lesser General Public License\n * (LGPL) version 2.1 which accompanies this distribution, and is available at\n * http://www.gnu.org/licenses/lgpl-2.1.html\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n */\n\n\nvar Content = require(\"./Content\");\n\nvar inherits = require(\"inherits\");\n\n\n/**\n * @constructor\n *\n * @param {String} url: URL of the WebRTC endpoint server.\n * @param {Object} options: optional configuration parameters\n *   {Enum('inactive', 'sendonly', 'recvonly', 'sendrecv')} audio: audio stream mode\n *   {Enum('inactive', 'sendonly', 'recvonly', 'sendrecv')} video: video stream mode\n *   {[Object]} iceServers: array of objects to initialize the ICE servers. It\n *     structure is the same as an Array of WebRTC RTCIceServer objects.\n *   {Boolean} [autostart=true]: flag to manually start media\n *\n * @throws RangeError\n */\nfunction KwsContentPlayer(url, options)\n{\n  options = options || {};\n\n  if(options.autostart == undefined)\n     options.autostart = true;\n\n  Content.call(this, url, options);\n\n  var self = this;\n\n  var Content_start = this.start;\n\n\n  /**\n   * Callback when connection is succesful\n   *\n   * @private\n   *\n   * @param {Object} response: JsonRPC response\n   */\n  function success(result)\n  {\n    // Remote streams\n    if(self._video.remote)\n    {\n      var url = result.url;\n\n      if(options.remoteVideoTag)\n      {\n        var remoteVideo = self._setRemoteVideoTag(url);\n\n        remoteVideo.addEventListener('ended', function()\n        {\n          self.terminate();\n        })\n      }\n      else\n        console.warn(\"No remote video tag available, successful terminate event due to remote end will be no dispatched\");\n\n      self.emit('remotestream', {url: url});\n    };\n\n    // Notify we created the connection successfully\n    self.emit('start');\n  };\n\n\n  // RPC calls\n\n  // Start\n\n  /**\n   * Request a connection with the webRTC endpoint server\n   *\n   * @private\n   */\n  this.start = function()\n  {\n    var params =\n    {\n      constraints:\n      {\n        audio: options.audio,\n        video: options.video\n      }\n    };\n\n    Content_start.call(self, params, success);\n  };\n\n  if(options.autostart)\n    this.start();\n\n\n  function close(reason)\n  {\n    if(reason == Content.REASON_SERVER_ENDED_SESSION)\n      return;\n\n    var remoteVideo = document.getElementById(options.remoteVideoTag);\n    if(remoteVideo) {\n        remoteVideo.src = '';\n        remoteVideo.removeAttribute('src');\n    }\n  };\n\n  this.on('error',     close);\n  this.on('terminate', close);\n};\ninherits(KwsContentPlayer, Content);\n\n\nmodule.exports = KwsContentPlayer;\n","/*\n * (C) Copyright 2013 Kurento (http://kurento.org/)\n *\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the GNU Lesser General Public License\n * (LGPL) version 2.1 which accompanies this distribution, and is available at\n * http://www.gnu.org/licenses/lgpl-2.1.html\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n */\n\n\n/*\n * @module kwsContentApi\n */\n\nvar Content = require(\"./Content\");\n\nvar inherits       = require(\"inherits\");\nvar XMLHttpRequest = require(\"xmlhttprequest\");\n\n\nfunction drop(event)\n{\n  event.stopPropagation();\n  event.preventDefault();\n\n  this._filesContainer = event.dataTransfer;\n};\nfunction dragover(event)\n{\n  event.stopPropagation();\n  event.preventDefault();\n\n  event.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.\n};\n\n/**\n * Upload a file to a Media Server\n * \n * @constructor\n * @extend Content\n * \n * @param {string} url - URL of the Connect Server endpoint\n * @param {KwsContentUploader} [options]\n */\nfunction KwsContentUploader(url, options)\n{\n  options = options || {};\n\n  if(options.autostart == undefined)\n     options.autostart = true;\n\n  Content.call(this, url, options);\n\n  var self = this;\n\n  var Content_start = this.start;\n\n\n  function sendFiles(container)\n  {\n    var files = container.files;\n    if(files)\n      self.send(files);\n  };\n\n\n  var url;\n\n  function doSend(file)\n  {\n    // XmlHttpRequest object used to upload the files\n    var xhr = new XMLHttpRequest();\n\n    xhr.upload.addEventListener('error', function(error)\n    {\n      self.emit('error', error);\n    });\n    xhr.upload.addEventListener('load', function(event)\n    {\n      console.log(event);\n      self.emit('localfile');\n//      self.emit('localfile', file);\n    });\n\n    // Connect to Media Server\n    xhr.open('POST', url);\n\n    // Send the file\n    xhr.send(file);\n  };\n\n\n  function success(result)\n  {\n    // Set the url where to upload the file\n    url = result.url;\n\n    //\n    // Set events on elements (if specified)\n    //\n\n    // Input tag\n    var inputTag = options.inputTag;\n    if(inputTag)\n    {\n      var input = document.getElementById(inputTag);\n      if(!input)\n        throw new SyntaxError(\"ID \"+inputTag+\" was not found\");\n\n      input.addEventListener('change', function(event)\n      {\n        sendFiles(input);\n      });\n\n      // Send previously selected files\n      sendFiles(input);\n    };\n\n    // Drag & Drop area\n    var dragdropTag = options.dragdropTag;\n    if(dragdropTag)\n    {\n      var div = document.getElementById(dragdropTag);\n      if(!div)\n        throw new SyntaxError(\"ID \"+dragdropTag+\" was not found\");\n\n      // Set events if they were not set before\n      div.addEventListener('drop', drop);\n      div.addEventListener('dragover', dragover);\n\n      // Send previously dropped files\n      var filesContainer = div._filesContainer;\n      if(filesContainer)\n        sendFiles(filesContainer);\n    };\n\n    self.emit('start');\n  };\n\n\n  /**\n   * Request to the content server the URL where to upload the file\n   */\n  this.start = function()\n  {\n    var params =\n    {\n      constraints:\n      {\n        audio: 'sendonly',\n        video: 'sendonly'\n      }\n    };\n\n    Content_start.call(self, params, success);\n  };\n\n  if(options.autostart)\n    this.start();\n\n\n  //\n  // Methods\n  //\n\n  /**\n   * Upload a file\n   * \n   * @param {File} file - media file to be uploaded to the server\n   */\n  this.send = function(file)\n  {\n    if(!this.sessionId)\n      throw new SyntaxError(\"Connection with media server is not stablished\");\n\n    // Fileset\n    if(file instanceof FileList)\n    {\n      // Fileset with several files\n      if(file.lenght > 1)\n      {\n        var formData = new FormData();\n        for(var i=0, f; f=file[i]; i++)\n          formData.append(\"file_\"+i, f);\n        file = formData;\n      }\n\n      // Fileset with zero or one files\n      else\n        file = file[0];\n    }\n\n    // Forced usage of FormData\n    else if(options.useFormData)\n    {\n      var formData = new FormData();\n      formData.append(\"file\", file);\n      file = formData;\n    }\n\n    // Send the file\n    doSend(file);\n  };\n};\ninherits(KwsContentUploader, Content);\n\n\nKwsContentUploader.initDragDrop = function(id)\n{\n  var div = document.getElementById(id);\n  if(!div)\n    throw new SyntaxError(\"ID \"+id+\" was not found\");\n\n  div.addEventListener('drop', drop);\n  div.addEventListener('dragover', dragover);\n};\n\n\n/**\n * @typedef {object} KwsContentUploader\n * @property {Boolean} [useFormData] - select if files should be uploaded as raw\n *   Blobs or inside a FormData object\n * @property {string} [inputTag] - ID of the input tag that will host the file\n * @property {string} [dragdropTag] - ID of the element where to drop the files\n */\n\n\nmodule.exports = KwsContentUploader;\n","/*\n * (C) Copyright 2013 Kurento (http://kurento.org/)\n *\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the GNU Lesser General Public License\n * (LGPL) version 2.1 which accompanies this distribution, and is available at\n * http://www.gnu.org/licenses/lgpl-2.1.html\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n */\n\n\nvar Content = require(\"./Content\");\n\nvar inherits = require(\"inherits\");\n\n\n/**\n * @constructor\n *\n * @param {String} url: URL of the WebRTC endpoint server.\n * @param {Object} options: optional configuration parameters\n *   {Enum('inactive', 'sendonly', 'recvonly', 'sendrecv')} audio: audio stream mode\n *   {Enum('inactive', 'sendonly', 'recvonly', 'sendrecv')} video: video stream mode\n *   {[Object]} iceServers: array of objects to initialize the ICE servers. It\n *     structure is the same as an Array of WebRTC RTCIceServer objects.\n *\n * @throws RangeError\n */\nfunction KwsWebRtcContent(url, options)\n{\n  options = options || {};\n\n  if(options.autostart == undefined)\n     options.autostart = true;\n\n  Content.call(this, url, options);\n\n  var self = this;\n\n  var Content_start = this.start;\n\n\n  var pc = null;\n\n\n  function onerror(error)\n  {\n    self.emit('error', error);\n  };\n\n\n  /**\n   * Request a connection with the webRTC endpoint server\n   *\n   * @private\n   *\n   * @param {MediaStream | undefined} localStream: stream locally offered\n   */\n  function initRtc(localStream)\n  {\n    if(localStream)\n      console.log('User has granted access to local media.');\n\n    // Create the PeerConnection object\n    var iceServers = options.iceServers\n                  || [{url: 'stun:'+'stun.l.google.com:19302'}];\n\n    pc = new RTCPeerConnection\n    (\n      {iceServers: iceServers},\n      {optional: [{DtlsSrtpKeyAgreement: true}]}\n    );\n\n    // Add the local stream if defined\n    if(localStream)\n      pc.addStream(localStream);\n\n    var mediaConstraints =\n    {\n      mandatory:\n      {\n        OfferToReceiveAudio: self._audio.remote,\n        OfferToReceiveVideo: self._video.remote\n      }\n    };\n\n    pc.createOffer(function(offer)\n    {\n      // Set the peer local description\n      pc.setLocalDescription(offer,\n      function()\n      {\n        console.info(\"LocalDescription correctly set\");\n      },\n      onerror);\n    },\n    onerror,\n    mediaConstraints);\n\n    // PeerConnection events\n\n    pc.onicecandidate = function(event)\n    {\n      // We are still generating the candidates, don't send the SDP yet.\n      if(event.candidate) return;\n\n      var params =\n      {\n        sdp: pc.localDescription.sdp,\n        constraints:\n        {\n          audio: options.audio,\n          video: options.video\n        }\n      };\n\n      console.debug('offer: '+params.sdp);\n\n      Content_start.call(self, params, success);\n    };\n\n    // Dispatch 'close' event if signaling gets closed\n    pc.onsignalingstatechange = function(event)\n    {\n      if(pc.signalingState == \"closed\")\n        self.emit('terminate');\n    };\n  }\n\n\n  /**\n   * Callback when connection is succesful\n   *\n   * @private\n   *\n   * @param {Object} response: JsonRPC response\n   */\n  function success(result)\n  {\n    console.debug('answer: '+result.sdp);\n\n    // Set answer description and init local environment\n    pc.setRemoteDescription(new RTCSessionDescription(\n    {\n      type: 'answer',\n      sdp: result.sdp\n    }),\n    success2,\n    onerror);\n  };\n\n  function success2()\n  {\n    // Local streams\n    if(self._video.local)\n    {\n      var stream = pc.getLocalStreams()[0];\n      if(!stream)\n        return onerror(new Error(\"No local streams are available\"));\n\n      var url = URL.createObjectURL(stream);\n\n      if(options.localVideoTag)\n      {\n        var localVideo = document.getElementById(options.localVideoTag);\n        if(!localVideo)\n        {\n          var msg = \"Requested local video tag '\"+options.localVideoTag\n                  + \"' is not available\";\n          return onerror(new Error(msg));\n        };\n\n        localVideo.muted = true;\n        localVideo.src = url;\n      };\n\n      self.emit('localstream', {stream: stream, url: url});\n    };\n\n    // Remote streams\n    if(self._video.remote)\n    {\n      var stream = pc.getRemoteStreams()[0];\n      if(!stream)\n        return self.emit('error', new Error(\"No remote streams are available\"));\n\n      var url = URL.createObjectURL(stream);\n\n      if(options.remoteVideoTag)\n      {\n        var remoteVideo = self._setRemoteVideoTag(url);\n\n      }\n      else\n        console.warn(\"No remote video tag available, successful terminate event due to remote end will be no dispatched\");\n\n      self.emit('remotestream', {stream: stream, url: url});\n    };\n\n    // Notify we created the connection successfully\n    self.emit('start');\n  };\n\n\n  /**\n   * Terminate the connection with the WebRTC media server\n   */\n  function close()\n  {\n    if(pc.signalingState == \"closed\")\n      return;\n\n    // Close the PeerConnection\n    pc.close();\n  };\n\n  this.on('error',     close);\n  this.on('terminate', close);\n\n\n  // Mode set to send local audio and/or video stream\n  this.start = function()\n  {\n    var audio = this._audio.local;\n    var video = this._video.local;\n\n    if(audio || video)\n    {\n      var constraints =\n      {\n        audio: audio,\n        video: video\n      };\n\n      getUserMedia(constraints, initRtc, onerror);\n    }\n\n    // Mode set to only receive a stream, not send it\n    else\n      initRtc();\n  }\n\n  if(options.autostart)\n    this.start();\n};\ninherits(KwsWebRtcContent, Content);\n\n\nmodule.exports = KwsWebRtcContent;\n","/*\n * (C) Copyright 2013 Kurento (http://kurento.org/)\n *\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the GNU Lesser General Public License\n * (LGPL) version 2.1 which accompanies this distribution, and is available at\n * http://www.gnu.org/licenses/lgpl-2.1.html\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n */\n\n\nvar EventEmitter = require(\"events\").EventEmitter;\nvar inherits     = require('inherits');\n\nvar XMLHttpRequest = require(\"xmlhttprequest\");\n\nvar RpcBuilder     = require(\"kws-rpc-builder\");\nvar JsonRPC        = RpcBuilder.packers.JsonRPC;\n\n\nconst MAX_FRAMERATE = 15;\n\n\n/**\n * @constructor\n * @abstract\n *\n * @param {String} url: URL of the WebRTC endpoint server.\n * @param {Object} options: optional configuration parameters\n *   {Enum('inactive', 'sendonly', 'recvonly', 'sendrecv')} audio: audio stream mode\n *   {Enum('inactive', 'sendonly', 'recvonly', 'sendrecv')} video: video stream mode\n *   {[Object]} iceServers: array of objects to initialize the ICE servers. It\n *     structure is the same as an Array of WebRTC RTCIceServer objects.\n *\n * @throws RangeError\n */\nfunction Content(url, options)\n{\n  EventEmitter.call(this);\n\n  var self = this;\n\n\n  const ERROR_NO_REMOTE_VIDEO_TAG = -1;\n\n\n  /**\n   * Decode the mode of the streams\n   *\n   * @private\n   *\n   * @param {Object} options: constraints to update and decode\n   * @param {String} type: name of the constraints to decode\n   *\n   * @returns {Object}\n   *\n   * @throws RangeError\n   */\n  function decodeMode(options, type)\n  {\n    var result = {};\n\n    // If not defined, set send & receive by default\n    options[type] = options[type] || 'sendrecv';\n\n    switch(options[type])\n    {\n      case 'sendrecv':\n        result.local  = true;\n        result.remote = true;\n      break;\n\n      case 'sendonly':\n        result.local  = true;\n        result.remote = false;\n      break;\n\n      case 'recvonly':\n        result.local  = false;\n        result.remote = true;\n      break;\n\n      case 'inactive':\n        result.local  = false;\n        result.remote = false;\n      break;\n\n      default:\n        throw new RangeError(\"Invalid \"+type+\" media mode\");\n    }\n\n    return result;\n  }\n\n  // We can't disable both audio and video on a stream, raise error\n  if(options.audio == 'inactive' && options.video == 'inactive')\n    throw new RangeError(\"At least one audio or video must to be enabled\");\n\n  // Audio media\n  this._audio = decodeMode(options, \"audio\");\n\n  // Video media\n  this._video = decodeMode(options, \"video\");\n\n  if(this._video.local)\n      this._video.local =\n      {\n        mandatory:\n        {\n//          minHeight   : options.minHeight    || MIN_HEIGHT,\n//          maxHeight   : options.maxHeight    || MAX_HEIGHT,\n//          minWidth    : options.minWidth     || MIN_WIDTH,\n//          maxWidth    : options.maxWidth     || MAX_WIDTH,\n//          minFrameRate: options.minFrameRate || MIN_FRAMERATE,\n          maxFrameRate: options.maxFrameRate || MAX_FRAMERATE\n        }\n      };\n\n  // Init the KwsWebRtcContent object\n\n  var _sessionId = null;\n  var pollingTimeout = null;\n  var polling = false;\n  var terminatedByServer = false;\n\n\n  this.__defineGetter__('sessionId', function()\n  {\n    return _sessionId;\n  });\n\n\n  function setSessionId(sessionId)\n  {\n    if(sessionId == undefined)\n      throw new TypeError('sessionId is undefined');\n\n    if(_sessionId == undefined)\n      _sessionId = sessionId;\n\n    else if(sessionId != _sessionId)\n      throw new TypeError('sessionId is not equal to already defined one');\n  }\n\n\n  var rpc = new RpcBuilder(JsonRPC, {request_timeout: 30000});\n\n\n  function doRPC(method, params, callback)\n  {\n    var xhr = new XMLHttpRequest();\n\n    // Set XmlHttpRequest error callback\n    xhr.addEventListener('error', function(error)\n    {\n      self.emit('error', error);\n    });\n\n    // Connect to Content Server\n    xhr.open('POST', url);\n\n    // Send request\n    xhr.send(rpc.encode(method, params, callback));\n\n    // Register callback for the Application Server\n    xhr.addEventListener('load', function()\n    {\n      rpc.decode(this.responseText);\n    });\n  };\n\n\n  function close()\n  {\n//    xhr.abort();\n\n    _sessionId = null;\n  };\n\n  self.on('error',     close);\n  self.on('terminate', close);\n\n\n  // Error dispatcher functions\n\n  var MAX_ALLOWED_ERROR_TRIES = 10;\n\n  var error_tries = 0;\n\n\n  // RPC calls\n\n  // Start\n\n  this.start = function(params, success)\n  {\n    if(this.sessionId)\n      params.sessionId = this.sessionId;\n\n    doRPC('start', params, function(error, result)\n    {\n      error = error || result.rejected;\n\n      if(error) return self.emit('error', error);\n\n      setSessionId(result.sessionId);\n\n      success(result);\n    });\n  };\n\n\n  // Poll\n\n  /**\n   * Poll for events dispatched on the server pipeline\n   *\n   * @private\n   */\n  function pollMediaEvents()\n  {\n    if(!self.sessionId) return;\n\n    if(!polling) return;\n\n    var params =\n    {\n      sessionId: self.sessionId\n    };\n\n    function success(result)\n    {\n      error_tries = 0;\n\n      // Content events\n      if(result.contentEvents)\n        for(var i=0, data; data=result.contentEvents[i]; i++)\n          self.emit('mediaevent', data);\n\n      // Control events\n      if(result.controlEvents)\n        for(var i=0, data; data=result.controlEvents[i]; i++)\n        {\n          var type = data.type;\n\n          switch(type)\n          {\n            case \"sessionTerminated\":\n              terminatedByServer = true;\n              self.emit('terminate', Content.REASON_SERVER_ENDED_SESSION);\n            break;\n\n            case \"sessionError\":\n              self.emit('error', data.data);\n            break;\n\n            default:\n              console.warn(\"Unknown control event type: \"+type);\n          }\n        };\n\n      // Check if we should keep polling events\n      if(pollingTimeout != 'stopped')\n      {\n        clearTimeout(pollingTimeout);\n        pollingTimeout = setTimeout(pollMediaEvents, 0);\n      }\n    };\n\n    function failure(error)\n    {\n      // A poll error has occurred, retry it\n      if(error.code != -32602 && error_tries < MAX_ALLOWED_ERROR_TRIES)\n      {\n        if(pollingTimeout != 'stopped')\n        {\n          clearTimeout(pollingTimeout);\n          pollingTimeout = setTimeout(pollMediaEvents, Math.pow(2, error_tries)*1000);\n        }\n\n        error_tries++;\n      }\n\n      // Max number of poll errors achieved, raise error\n      else\n        terminateConnection('error', error);\n    };\n\n    doRPC('poll', params, function(error, result)\n    {\n      if(error) return failure(error);\n\n      success(result);\n    });\n  };\n\n  function startPolling()\n  {\n    if(polling) return;\n\n    polling = true;\n    pollMediaEvents()\n  };\n\n  this.on('start',   startPolling);\n  this.on('execute', startPolling);\n\n\n  /**\n   * Terminate the connection with the WebRTC media server\n   */\n  function terminateConnection(action, reason)\n  {\n    // Stop polling\n    clearTimeout(pollingTimeout);\n    pollingTimeout = 'stopped';\n    polling = false;\n\n    if(terminatedByServer)\n      return;\n\n    // Notify to the WebRTC endpoint server\n    if(self.sessionId)\n    {\n      var params =\n      {\n        sessionId: self.sessionId,\n        reason: reason\n      };\n\n      doRPC('terminate', params, function()\n      {\n        self.emit(action, reason);\n      });\n\n      _sessionId = null;\n    };\n  };\n\n\n  //\n  // Methods\n  //\n\n  /**\n   * @private\n   */\n  this._setRemoteVideoTag = function(src)\n  {\n    var remoteVideo = document.getElementById(options.remoteVideoTag);\n    if(remoteVideo)\n    {\n      remoteVideo.src = src;\n\n      return remoteVideo;\n    };\n\n    var msg = \"Requested remote video tag '\" + options.remoteVideoTag\n            + \"' is not available\";\n\n    var error = new Error(msg);\n        error.code = ERROR_NO_REMOTE_VIDEO_TAG;\n\n    self.emit('error', error);\n  };\n\n\n  /**\n   * Send a command to be executed on the server\n   *\n   * @param {string} type - The command to execute\n   * @param {*} data - Data needed by the command\n   * @param {} callback - Function executed after getting a result or an error\n   */\n  this.execute = function(type, data, callback)\n  {\n    callback = callback || function(){};\n\n    var params =\n    {\n      command:\n      {\n        type: type,\n        data: data\n      }\n    };\n\n    if(this.sessionId)\n      params.sessionId = this.sessionId;\n\n    doRPC('execute', params, function(error, result)\n    {\n      if(error) return callback(error);\n\n      setSessionId(result.sessionId);\n\n      self.emit('execute');\n      callback(null, result.commandResult);\n    });\n  }\n\n  /**\n   * Close the connection\n   */\n  this.terminate = function()\n  {\n    terminateConnection('terminate', Content.REASON_USER_ENDED_SESSION);\n  };\n};\ninherits(Content, EventEmitter);\n\n\nContent.REASON_USER_ENDED_SESSION =\n{\n  code: 1,\n  message: \"User ended session\"\n};\nContent.REASON_SERVER_ENDED_SESSION =\n{\n  code: 2,\n  message: \"Server ended session\"\n};\n\n\nmodule.exports = Content;\n","// Copyright Joyent, Inc. and other Node contributors.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a\n// copy of this software and associated documentation files (the\n// \"Software\"), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to permit\n// persons to whom the Software is furnished to do so, subject to the\n// following conditions:\n//\n// The above copyright notice and this permission notice shall be included\n// in all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n// USE OR OTHER DEALINGS IN THE SOFTWARE.\n\nfunction EventEmitter() {\n  this._events = this._events || {};\n  this._maxListeners = this._maxListeners || undefined;\n}\nmodule.exports = EventEmitter;\n\n// Backwards-compat with node 0.10.x\nEventEmitter.EventEmitter = EventEmitter;\n\nEventEmitter.prototype._events = undefined;\nEventEmitter.prototype._maxListeners = undefined;\n\n// By default EventEmitters will print a warning if more than 10 listeners are\n// added to it. This is a useful default which helps finding memory leaks.\nEventEmitter.defaultMaxListeners = 10;\n\n// Obviously not all Emitters should be limited to 10. This function allows\n// that to be increased. Set to zero for unlimited.\nEventEmitter.prototype.setMaxListeners = function(n) {\n  if (!isNumber(n) || n < 0 || isNaN(n))\n    throw TypeError('n must be a positive number');\n  this._maxListeners = n;\n  return this;\n};\n\nEventEmitter.prototype.emit = function(type) {\n  var er, handler, len, args, i, listeners;\n\n  if (!this._events)\n    this._events = {};\n\n  // If there is no 'error' event listener then throw.\n  if (type === 'error') {\n    if (!this._events.error ||\n        (isObject(this._events.error) && !this._events.error.length)) {\n      er = arguments[1];\n      if (er instanceof Error) {\n        throw er; // Unhandled 'error' event\n      } else {\n        throw TypeError('Uncaught, unspecified \"error\" event.');\n      }\n      return false;\n    }\n  }\n\n  handler = this._events[type];\n\n  if (isUndefined(handler))\n    return false;\n\n  if (isFunction(handler)) {\n    switch (arguments.length) {\n      // fast cases\n      case 1:\n        handler.call(this);\n        break;\n      case 2:\n        handler.call(this, arguments[1]);\n        break;\n      case 3:\n        handler.call(this, arguments[1], arguments[2]);\n        break;\n      // slower\n      default:\n        len = arguments.length;\n        args = new Array(len - 1);\n        for (i = 1; i < len; i++)\n          args[i - 1] = arguments[i];\n        handler.apply(this, args);\n    }\n  } else if (isObject(handler)) {\n    len = arguments.length;\n    args = new Array(len - 1);\n    for (i = 1; i < len; i++)\n      args[i - 1] = arguments[i];\n\n    listeners = handler.slice();\n    len = listeners.length;\n    for (i = 0; i < len; i++)\n      listeners[i].apply(this, args);\n  }\n\n  return true;\n};\n\nEventEmitter.prototype.addListener = function(type, listener) {\n  var m;\n\n  if (!isFunction(listener))\n    throw TypeError('listener must be a function');\n\n  if (!this._events)\n    this._events = {};\n\n  // To avoid recursion in the case that type === \"newListener\"! Before\n  // adding it to the listeners, first emit \"newListener\".\n  if (this._events.newListener)\n    this.emit('newListener', type,\n              isFunction(listener.listener) ?\n              listener.listener : listener);\n\n  if (!this._events[type])\n    // Optimize the case of one listener. Don't need the extra array object.\n    this._events[type] = listener;\n  else if (isObject(this._events[type]))\n    // If we've already got an array, just append.\n    this._events[type].push(listener);\n  else\n    // Adding the second element, need to change to array.\n    this._events[type] = [this._events[type], listener];\n\n  // Check for listener leak\n  if (isObject(this._events[type]) && !this._events[type].warned) {\n    var m;\n    if (!isUndefined(this._maxListeners)) {\n      m = this._maxListeners;\n    } else {\n      m = EventEmitter.defaultMaxListeners;\n    }\n\n    if (m && m > 0 && this._events[type].length > m) {\n      this._events[type].warned = true;\n      console.error('(node) warning: possible EventEmitter memory ' +\n                    'leak detected. %d listeners added. ' +\n                    'Use emitter.setMaxListeners() to increase limit.',\n                    this._events[type].length);\n      if (typeof console.trace === 'function') {\n        // not supported in IE 10\n        console.trace();\n      }\n    }\n  }\n\n  return this;\n};\n\nEventEmitter.prototype.on = EventEmitter.prototype.addListener;\n\nEventEmitter.prototype.once = function(type, listener) {\n  if (!isFunction(listener))\n    throw TypeError('listener must be a function');\n\n  var fired = false;\n\n  function g() {\n    this.removeListener(type, g);\n\n    if (!fired) {\n      fired = true;\n      listener.apply(this, arguments);\n    }\n  }\n\n  g.listener = listener;\n  this.on(type, g);\n\n  return this;\n};\n\n// emits a 'removeListener' event iff the listener was removed\nEventEmitter.prototype.removeListener = function(type, listener) {\n  var list, position, length, i;\n\n  if (!isFunction(listener))\n    throw TypeError('listener must be a function');\n\n  if (!this._events || !this._events[type])\n    return this;\n\n  list = this._events[type];\n  length = list.length;\n  position = -1;\n\n  if (list === listener ||\n      (isFunction(list.listener) && list.listener === listener)) {\n    delete this._events[type];\n    if (this._events.removeListener)\n      this.emit('removeListener', type, listener);\n\n  } else if (isObject(list)) {\n    for (i = length; i-- > 0;) {\n      if (list[i] === listener ||\n          (list[i].listener && list[i].listener === listener)) {\n        position = i;\n        break;\n      }\n    }\n\n    if (position < 0)\n      return this;\n\n    if (list.length === 1) {\n      list.length = 0;\n      delete this._events[type];\n    } else {\n      list.splice(position, 1);\n    }\n\n    if (this._events.removeListener)\n      this.emit('removeListener', type, listener);\n  }\n\n  return this;\n};\n\nEventEmitter.prototype.removeAllListeners = function(type) {\n  var key, listeners;\n\n  if (!this._events)\n    return this;\n\n  // not listening for removeListener, no need to emit\n  if (!this._events.removeListener) {\n    if (arguments.length === 0)\n      this._events = {};\n    else if (this._events[type])\n      delete this._events[type];\n    return this;\n  }\n\n  // emit removeListener for all listeners on all events\n  if (arguments.length === 0) {\n    for (key in this._events) {\n      if (key === 'removeListener') continue;\n      this.removeAllListeners(key);\n    }\n    this.removeAllListeners('removeListener');\n    this._events = {};\n    return this;\n  }\n\n  listeners = this._events[type];\n\n  if (isFunction(listeners)) {\n    this.removeListener(type, listeners);\n  } else {\n    // LIFO order\n    while (listeners.length)\n      this.removeListener(type, listeners[listeners.length - 1]);\n  }\n  delete this._events[type];\n\n  return this;\n};\n\nEventEmitter.prototype.listeners = function(type) {\n  var ret;\n  if (!this._events || !this._events[type])\n    ret = [];\n  else if (isFunction(this._events[type]))\n    ret = [this._events[type]];\n  else\n    ret = this._events[type].slice();\n  return ret;\n};\n\nEventEmitter.listenerCount = function(emitter, type) {\n  var ret;\n  if (!emitter._events || !emitter._events[type])\n    ret = 0;\n  else if (isFunction(emitter._events[type]))\n    ret = 1;\n  else\n    ret = emitter._events[type].length;\n  return ret;\n};\n\nfunction isFunction(arg) {\n  return typeof arg === 'function';\n}\n\nfunction isNumber(arg) {\n  return typeof arg === 'number';\n}\n\nfunction isObject(arg) {\n  return typeof arg === 'object' && arg !== null;\n}\n\nfunction isUndefined(arg) {\n  return arg === void 0;\n}\n","if (typeof Object.create === 'function') {\n  // implementation from standard node.js 'util' module\n  module.exports = function inherits(ctor, superCtor) {\n    ctor.super_ = superCtor\n    ctor.prototype = Object.create(superCtor.prototype, {\n      constructor: {\n        value: ctor,\n        enumerable: false,\n        writable: true,\n        configurable: true\n      }\n    });\n  };\n} else {\n  // old school shim for old browsers\n  module.exports = function inherits(ctor, superCtor) {\n    ctor.super_ = superCtor\n    var TempCtor = function () {}\n    TempCtor.prototype = superCtor.prototype\n    ctor.prototype = new TempCtor()\n    ctor.prototype.constructor = ctor\n  }\n}\n","module.exports = XMLHttpRequest;","/*\n * (C) Copyright 2014 Kurento (http://kurento.org/)\n *\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the GNU Lesser General Public License\n * (LGPL) version 2.1 which accompanies this distribution, and is available at\n * http://www.gnu.org/licenses/lgpl-2.1.html\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n */\n\nvar EventEmitter = require('events').EventEmitter;\n\nvar inherits = require('inherits');\n\nvar packers = require('./packers');\nvar Mapper = require('./Mapper');\n\n\nconst BASE_TIMEOUT = 5000;\n\n\nfunction unifyResponseMethods(responseMethods)\n{\n  if(!responseMethods) return {};\n\n  for(var key in responseMethods)\n  {\n    var value = responseMethods[key];\n\n    if(typeof value == 'string')\n      responseMethods[key] =\n      {\n        response: value\n      }\n  };\n\n  return responseMethods;\n};\n\nfunction unifyTransport(transport)\n{\n  if(!transport) return;\n\n  if(transport instanceof Function)\n    return transport;\n\n  if(transport.send instanceof Function)\n    return transport.send.bind(transport);\n\n  if(transport.postMessage instanceof Function)\n    return transport.postMessage.bind(transport);\n\n  // Transports that only can receive messages, but not send\n  if(transport.onmessage !== undefined) return;\n\n  throw new SyntaxError(\"Transport is not a function nor a valid object\");\n};\n\n\n/**\n * Representation of a RPC notification\n *\n * @class\n *\n * @constructor\n *\n * @param {String} method -method of the notification\n * @param params - parameters of the notification\n */\nfunction RpcNotification(method, params)\n{\n  Object.defineProperty(this, 'method', {value: method, enumerable: true});\n  Object.defineProperty(this, 'params', {value: params, enumerable: true});\n};\n\n\n/**\n * @class\n *\n * @constructor\n */\nfunction RpcBuilder(packer, options, transport, onRequest)\n{\n  var self = this;\n\n  if(!packer)\n    throw new SyntaxError('Packer is not defined');\n\n  if(!packer.pack || !packer.unpack)\n    throw new SyntaxError('Packer is invalid');\n\n  var responseMethods = unifyResponseMethods(packer.responseMethods);\n\n\n  if(options instanceof Function || options && options.send instanceof Function)\n  {\n    if(transport && !(transport instanceof Function))\n      throw new SyntaxError(\"Only a function can be after transport\");\n\n    onRequest = transport;\n    transport = options;\n    options   = undefined;\n  };\n\n  if(transport instanceof Function\n  || transport && transport.send instanceof Function)\n    if(onRequest && !(onRequest instanceof Function))\n      throw new SyntaxError(\"Only a function can be after transport\");\n\n  options = options || {};\n\n\n  EventEmitter.call(this);\n\n  if(onRequest)\n    this.on('request', onRequest);\n\n\n  Object.defineProperty(this, 'peerID', {value: options.peerID});\n\n  var max_retries = options.max_retries || 0;\n\n\n  function transportMessage(event)\n  {\n    var message = self.decode(event.data);\n    if(message)\n      self.emit('request', message);\n  };\n\n  Object.defineProperty(this, 'transport',\n  {\n    get: function()\n    {\n      return transport;\n    },\n\n    set: function(value)\n    {\n      // Remove listener from old transport\n      if(transport && transport.onmessage !== undefined)\n        transport.removeEventListener('message', transportMessage);\n\n      // Set listener on new transport\n      if(value && value.onmessage !== undefined)\n        value.addEventListener('message', transportMessage);\n\n      transport = unifyTransport(value);\n    }\n  })\n\n  this.transport = transport;\n\n\n  const request_timeout    = options.request_timeout    || BASE_TIMEOUT;\n  const response_timeout   = options.response_timeout   || BASE_TIMEOUT;\n  const duplicates_timeout = options.duplicates_timeout || BASE_TIMEOUT;\n\n\n  var requestID = 0;\n\n  var requests  = new Mapper();\n  var responses = new Mapper();\n  var processedResponses = new Mapper();\n\n  var message2Key = {};\n\n\n  /**\n   * Store the response to prevent to process duplicate request later\n   */\n  function storeResponse(message, id, dest)\n  {\n    var response =\n    {\n      message: message,\n      /** Timeout to auto-clean old responses */\n      timeout: setTimeout(function()\n      {\n        responses.remove(id, dest);\n      },\n      response_timeout)\n    };\n\n    responses.set(response, id, dest);\n  };\n\n  /**\n   * Store the response to ignore duplicated messages later\n   */\n  function storeProcessedResponse(ack, from)\n  {\n    var timeout = setTimeout(function()\n    {\n      processedResponses.remove(ack, from);\n    },\n    duplicates_timeout);\n\n    processedResponses.set(timeout, ack, from);\n  };\n\n\n  /**\n   * Representation of a RPC request\n   *\n   * @class\n   * @extends RpcNotification\n   *\n   * @constructor\n   *\n   * @param {String} method -method of the notification\n   * @param params - parameters of the notification\n   * @param {Integer} id - identifier of the request\n   * @param [from] - source of the notification\n   */\n  function RpcRequest(method, params, id, from, transport)\n  {\n    RpcNotification.call(this, method, params);\n\n    Object.defineProperty(this, 'transport',\n    {\n      get: function()\n      {\n        return transport;\n      },\n\n      set: function(value)\n      {\n        transport = unifyTransport(value);\n      }\n    })\n\n    var response = responses.get(id, from);\n\n    /**\n     * @constant {Boolean} duplicated\n     */\n    if(!(transport || self.transport))\n      Object.defineProperty(this, 'duplicated',\n      {\n        value: Boolean(response)\n      });\n\n    var responseMethod = responseMethods[method];\n\n    this.pack = function()\n    {\n      return packer.pack(this, id);\n    }\n\n    /**\n     * Generate a response to this request\n     *\n     * @param {Error} [error]\n     * @param {*} [result]\n     *\n     * @returns {string}\n     */\n    this.reply = function(error, result, transport)\n    {\n      // Fix optional parameters\n      if(error instanceof Function || error && error.send instanceof Function)\n      {\n        if(result != undefined)\n          throw new SyntaxError(\"There can't be parameters after callback\");\n\n        transport = error;\n        result = null;\n        error = undefined;\n      }\n\n      else if(result instanceof Function\n      || result && result.send instanceof Function)\n      {\n        if(transport != undefined)\n          throw new SyntaxError(\"There can't be parameters after callback\");\n\n        transport = result;\n        result = null;\n      };\n\n      transport = unifyTransport(transport);\n\n      // Duplicated request, remove old response timeout\n      if(response)\n        clearTimeout(response.timeout);\n\n      if(from != undefined)\n      {\n        if(error)\n          error.dest = from;\n\n        if(result)\n          result.dest = from;\n      };\n\n      var message;\n\n      // New request or overriden one, create new response with provided data\n      if(error || result != undefined)\n      {\n        if(self.peerID != undefined)\n        {\n          if(error)\n            error.from = self.peerID;\n          else\n            result.from = self.peerID;\n        }\n\n        // Protocol indicates that responses has own request methods\n        if(responseMethod)\n        {\n          if(responseMethod.error == undefined && error)\n            message =\n            {\n              error: error\n            };\n\n          else\n          {\n            var method = error\n                       ? responseMethod.error\n                       : responseMethod.response;\n\n            message =\n            {\n              method: method,\n              params: error || result\n            };\n          }\n        }\n        else\n          message =\n          {\n            error:  error,\n            result: result\n          };\n\n        message = packer.pack(message, id);\n      }\n\n      // Duplicate & not-overriden request, re-send old response\n      else if(response)\n        message = response.message;\n\n      // New empty reply, response null value\n      else\n        message = packer.pack({result: null}, id);\n\n      // Store the response to prevent to process a duplicated request later\n      storeResponse(message, id, from);\n\n      // Return the stored response so it can be directly send back\n      transport = transport || this.transport || self.transport;\n\n      if(transport)\n        return transport(message);\n\n      return message;\n    }\n  };\n  inherits(RpcRequest, RpcNotification);\n\n\n  function cancel(message)\n  {\n    var key = message2Key[message];\n    if(!key) return;\n\n    delete message2Key[message];\n\n    var request = requests.pop(key.id, key.dest);\n    if(!request) return;\n\n    clearTimeout(request.timeout);\n\n    // Start duplicated responses timeout\n    storeProcessedResponse(key.id, key.dest);\n  };\n\n  /**\n   * Allow to cancel a request and don't wait for a response\n   *\n   * If `message` is not given, cancel all the request\n   */\n  this.cancel = function(message)\n  {\n    if(message) return cancel(message);\n\n    for(var message in message2Key)\n      cancel(message);\n  };\n\n\n  this.close = function()\n  {\n    // Prevent to receive new messages\n    var transport = self.transport;\n    if(transport && transport.close)\n       transport.close();\n\n    // Request & processed responses\n    this.cancel();\n\n    processedResponses.forEach(function(timeout)\n    {\n      clearTimeout(timeout);\n    });\n\n    // Responses\n    responses.forEach(function(response)\n    {\n      clearTimeout(response.timeout);\n    });\n  };\n\n\n  /**\n   * Generates and encode a JsonRPC 2.0 message\n   *\n   * @param {String} method -method of the notification\n   * @param params - parameters of the notification\n   * @param [dest] - destination of the notification\n   * @param {object} [transport] - transport where to send the message\n   * @param [callback] - function called when a response to this request is\n   *   received. If not defined, a notification will be send instead\n   *\n   * @returns {string} A raw JsonRPC 2.0 request or notification string\n   */\n  this.encode = function(method, params, dest, transport, callback)\n  {\n    // Fix optional parameters\n    if(params instanceof Function)\n    {\n      if(dest != undefined)\n        throw new SyntaxError(\"There can't be parameters after callback\");\n\n      callback  = params;\n      transport = undefined;\n      dest      = undefined;\n      params    = undefined;\n    }\n\n    else if(dest instanceof Function)\n    {\n      if(transport != undefined)\n        throw new SyntaxError(\"There can't be parameters after callback\");\n\n      callback  = dest;\n      transport = undefined;\n      dest      = undefined;\n    }\n\n    else if(transport instanceof Function)\n    {\n      if(callback != undefined)\n        throw new SyntaxError(\"There can't be parameters after callback\");\n\n      callback  = transport;\n      transport = undefined;\n    };\n\n    if(self.peerID != undefined)\n    {\n      params = params || {};\n\n      params.from = self.peerID;\n    };\n\n    if(dest != undefined)\n    {\n      params = params || {};\n\n      params.dest = dest;\n    };\n\n    // Encode message\n    var message =\n    {\n      method: method,\n      params: params\n    };\n\n    if(callback)\n    {\n      var id = requestID++;\n      var retried = 0;\n\n      message = packer.pack(message, id);\n\n      var request =\n      {\n        message:         message,\n        callback:        dispatchCallback,\n        responseMethods: responseMethods[method] || {}\n      };\n\n      function dispatchCallback(error, result)\n      {\n        self.cancel(message);\n\n        callback(error, result);\n      };\n\n      var encode_transport = unifyTransport(transport);\n\n      function sendRequest(transport)\n      {\n        request.timeout = setTimeout(timeout,\n                                     request_timeout*Math.pow(2, retried++));\n        message2Key[message] = {id: id, dest: dest};\n        requests.set(request, id, dest);\n\n        transport = transport || encode_transport || self.transport;\n        if(transport)\n          return transport(message);\n\n        return message;\n      };\n\n      function retry(transport)\n      {\n        transport = unifyTransport(transport);\n\n        console.warn(retried+' retry for request message:',message);\n\n        var timeout = processedResponses.pop(id, dest);\n        clearTimeout(timeout);\n\n        return sendRequest(transport);\n      };\n\n      function timeout()\n      {\n        if(retried < max_retries)\n          return retry(transport);\n\n        var error = new Error('Request has timed out');\n            error.request = message;\n\n        error.retry = retry;\n\n        dispatchCallback(error)\n      };\n\n      return sendRequest(transport);\n    };\n\n    // Return the packed message\n    message = packer.pack(message);\n\n    transport = transport || self.transport;\n    if(transport)\n      return transport(message);\n\n    return message;\n  };\n\n  /**\n   * Decode and process a JsonRPC 2.0 message\n   *\n   * @param {string} message - string with the content of the message\n   *\n   * @returns {RpcNotification|RpcRequest|undefined} - the representation of the\n   *   notification or the request. If a response was processed, it will return\n   *   `undefined` to notify that it was processed\n   *\n   * @throws {TypeError} - Message is not defined\n   */\n  this.decode = function(message, transport)\n  {\n    if(!message)\n      throw new TypeError(\"Message is not defined\");\n\n    try\n    {\n      message = packer.unpack(message);\n    }\n    catch(e)\n    {\n      // Ignore invalid messages\n      return console.debug(e, message);\n    };\n\n    var id     = message.id;\n    var ack    = message.ack;\n    var method = message.method;\n    var params = message.params || {};\n\n    var from = params.from;\n    var dest = params.dest;\n\n    // Ignore messages send by us\n    if(self.peerID != undefined && from == self.peerID) return;\n\n    // Notification\n    if(id == undefined && ack == undefined)\n      return new RpcNotification(method, params);\n\n\n    function processRequest()\n    {\n      // If we have a transport and it's a duplicated request, reply inmediatly\n      transport = unifyTransport(transport) || self.transport;\n      if(transport)\n      {\n        var response = responses.get(id, from);\n        if(response)\n          return transport(response.message);\n      };\n\n      var idAck = (id != undefined) ? id : ack;\n      return new RpcRequest(method, params, idAck, from, transport);\n    };\n\n    function processResponse(request, error, result)\n    {\n      request.callback(error, result);\n    };\n\n    function duplicatedResponse(timeout)\n    {\n      console.warn(\"Response already processed\", message);\n\n      // Update duplicated responses timeout\n      clearTimeout(timeout);\n      storeProcessedResponse(ack, from);\n    };\n\n\n    // Request, or response with own method\n    if(method)\n    {\n      // Check if it's a response with own method\n      if(dest == undefined || dest == self.peerID)\n      {\n        var request = requests.get(ack, from);\n        if(request)\n        {\n          var responseMethods = request.responseMethods;\n\n          if(method == responseMethods.error)\n            return processResponse(request, params);\n\n          if(method == responseMethods.response)\n            return processResponse(request, null, params);\n\n          return processRequest();\n        }\n\n        var processed = processedResponses.get(ack, from);\n        if(processed)\n          return duplicatedResponse(processed);\n      }\n\n      // Request\n      return processRequest();\n    };\n\n    var error  = message.error;\n    var result = message.result;\n\n    // Ignore responses not send to us\n    if(error  && error.dest  && error.dest  != self.sessionID) return;\n    if(result && result.dest && result.dest != self.sessionID) return;\n\n    // Response\n    var request = requests.get(ack, from);\n    if(!request)\n    {\n      var processed = processedResponses.get(ack, from);\n      if(processed)\n        return duplicatedResponse(processed);\n\n      return console.warn(\"No callback was defined for this message\", message);\n    };\n\n    // Process response\n    processResponse(request, error, result);\n  };\n};\ninherits(RpcBuilder, EventEmitter);\n\n\nRpcBuilder.RpcNotification = RpcNotification;\n\n\nmodule.exports = RpcBuilder;\n\nRpcBuilder.packers = packers;\n","function Mapper()\n{\n  var sources = {};\n\n\n  this.forEach = function(callback)\n  {\n    for(var key in sources)\n    {\n      var source = sources[key];\n\n      for(var key2 in source)\n        callback(source[key2]);\n    };\n  };\n\n  this.get = function(id, source)\n  {\n    var ids = sources[source];\n    if(ids == undefined)\n      return undefined;\n\n    return ids[id];\n  };\n\n  this.remove = function(id, source)\n  {\n    var ids = sources[source];\n    if(ids == undefined)\n      return;\n\n    delete ids[id];\n\n    if(!Object.keys(ids).length)\n      delete sources[source];\n  };\n\n  this.set = function(value, id, source)\n  {\n    if(value == undefined)\n      return this.remove(id, source);\n\n    var ids = sources[source];\n    if(ids == undefined)\n      sources[source] = ids = {};\n\n    ids[id] = value;\n  };\n};\n\n\nMapper.prototype.pop = function(id, source)\n{\n  var value = this.get(id, source);\n  if(value == undefined)\n    return undefined;\n\n  this.remove(id, source);\n\n  return value;\n};\n\n\nmodule.exports = Mapper;\n","var JsonRPC = require('./JsonRPC');\nvar XmlRPC  = require('./XmlRPC');\n\n\nexports.JsonRPC = JsonRPC;\nexports.XmlRPC  = XmlRPC;\n","/**\n * JsonRPC 2.0 packer\n */\n\n/**\n * Pack a JsonRPC 2.0 message\n *\n * @param {Object} message - object to be packaged. It requires to have all the\n *   fields needed by the JsonRPC 2.0 message that it's going to be generated\n *\n * @return {String} - the stringified JsonRPC 2.0 message\n */\nfunction pack(message, id)\n{\n  var result =\n  {\n    jsonrpc: \"2.0\"\n  };\n\n  // Request\n  if(message.method)\n  {\n    result.method = message.method;\n\n    if(message.params)\n      result.params = message.params;\n\n    // Request is a notification\n    if(id != undefined)\n      result.id = id;\n  }\n\n  // Response\n  else if(id != undefined)\n  {\n    if(message.error)\n    {\n      if(message.result !== undefined)\n        throw new TypeError(\"Both result and error are defined\");\n\n      result.error = message.error;\n    }\n    else if(message.result !== undefined)\n      result.result = message.result;\n    else\n      throw new TypeError(\"No result or error is defined\");\n\n    result.id = id;\n  };\n\n  return JSON.stringify(result);\n};\n\n/**\n * Unpack a JsonRPC 2.0 message\n *\n * @param {String} message - string with the content of the JsonRPC 2.0 message\n *\n * @throws {TypeError} - Invalid JsonRPC version\n *\n * @return {Object} - object filled with the JsonRPC 2.0 message content\n */\nfunction unpack(message)\n{\n  var result = message;\n\n  if(typeof message == 'string' || message instanceof String)\n    result = JSON.parse(message);\n\n  // Check if it's a valid message\n\n  var version = result.jsonrpc;\n  if(version != \"2.0\")\n    throw new TypeError(\"Invalid JsonRPC version '\"+version+\"': \"+message);\n\n  // Response\n  if(result.method == undefined)\n  {\n    if(result.id == undefined)\n      throw new TypeError(\"Invalid message: \"+message);\n\n    var result_defined = result.result !== undefined;\n    var error_defined  = result.error  !== undefined;\n\n    // Check only result or error is defined, not both or none\n    if(result_defined && error_defined)\n      throw new TypeError(\"Both result and error are defined: \"+message);\n\n    if(!result_defined && !error_defined)\n      throw new TypeError(\"No result or error is defined: \"+message);\n\n    result.ack = result.id;\n    delete result.id;\n  }\n\n  // Return unpacked message\n  return result;\n};\n\n\nexports.pack   = pack;\nexports.unpack = unpack;\n","function pack(message)\n{\n  throw new TypeError(\"Not yet implemented\");\n};\n\nfunction unpack(message)\n{\n  throw new TypeError(\"Not yet implemented\");\n};\n\n\nexports.pack   = pack;\nexports.unpack = unpack;\n"]}